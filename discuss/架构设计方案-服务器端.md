# douyin-processor 架构设计方案（服务器端）

## 1. 项目概述

**项目名称**：douyin-processor
**职责**：服务器端视频接收、音频处理和ASR识别
**运行环境**：阿里云ECS（Linux）
**运行方式**：持续运行

## 2. 核心功能

1. 提供视频上传API接口（无认证）
2. 接收视频文件并存储到接收目录
3. 每15分钟+扫描接收目录
4. 音频提取和转换（FFmpeg）
5. 调用阿里云ASR进行语音识别
6. 结果存储到output目录
7. 处理完成后删除原始视频文件

## 3. 目录结构

```
douyin-processor/
├── src/
│   ├── __init__.py
│   ├── server/
│   │   ├── __init__.py
│   │   ├── main.py         # FastAPI服务器
│   │   ├── endpoints.py    # API接口
│   │   └── models.py       # API数据模型
│   ├── processor/
│   │   ├── __init__.py
│   │   ├── audio_extractor.py  # 音频提取（从现有项目复用）
│   │   ├── asr_client.py       # ASR客户端（从现有项目复用）
│   │   ├── processor.py        # 处理器主逻辑
│   │   └── file_manager.py     # 文件管理
│   ├── models.py           # 数据模型（从现有项目复用）
│   └── utils.py            # 工具函数
├── scripts/
│   ├── run.sh              # Linux启动脚本
│   └── install_deps.sh     # 依赖安装
├── config/
│   └── app.yaml            # 应用配置
├── data/
│   ├── upload/             # 接收目录
│   ├── output/             # 输出目录
│   └── processing/         # 处理中目录
├── logs/                   # 日志目录
├── main.py                 # 主入口
├── pyproject.toml          # 项目配置
└── README.md
```

## 4. 配置文件（config/app.yaml）

```yaml
app:
  # 服务器配置
  server:
    host: "0.0.0.0"
    port: 8000
    max_file_size: 104857600  # 100MB

  # 文件配置
  files:
    upload_dir: "data/upload"
    output_dir: "data/output"
    processing_dir: "data/processing"

  # 处理配置
  processor:
    scan_interval: 900       # 15分钟
    max_retries: 3
    retry_delay: 60

  # 音频配置
  audio:
    output_format: "wav"
    sample_rate: 16000
    channels: 1

  # ASR配置
  asr:
    provider: "aliyun"
    access_key: "${ALIYUN_ACCESS_KEY}"
    access_secret: "${ALIYUN_ACCESS_SECRET}"
    region: "cn-hangzhou"

  # 日志配置
  logging:
    level: "INFO"
    console: true
    file: true
```

## 5. API接口设计

### 5.1 视频上传接口

**端点**：`POST /api/video/upload`

**请求**：
```http
Content-Type: multipart/form-data

file: <binary>              # 视频文件
metadata: <json string>     # 元数据（可选）
```

**元数据格式**：
```json
{
  "aweme_id": "7123456789012345678",
  "title": "视频标题",
  "author": "作者昵称",
  "duration": 60,
  "size": 102400000
}
```

**成功响应**：
```json
{
  "success": true,
  "message": "文件上传成功",
  "data": {
    "filename": "7123456789012345678.mp4",
    "size": 102400000,
    "upload_time": "2024-01-01T12:00:00Z"
  }
}
```

**错误响应**：
```json
{
  "success": false,
  "error": {
    "code": "INVALID_FILE_SIZE",
    "message": "文件大小超过限制（最大100MB）"
  }
}
```

## 6. 核心模块设计

### 6.1 server/endpoints.py（新建）

```python
"""
API接口端点
处理视频上传请求
"""

from fastapi import APIRouter, UploadFile, File, Form
from pathlib import Path

router = APIRouter()

@router.post("/api/video/upload")
async def upload_video(
    file: UploadFile = File(...),
    metadata: str = Form(None)
):
    """上传视频文件"""
    # 验证文件大小
    # 保存到upload目录
    # 返回上传结果
    pass
```

### 6.2 processor/processor.py（新建）

```python
"""
视频处理器
定时扫描upload目录并处理视频
"""

import asyncio
from pathlib import Path
from loguru import logger

class VideoProcessor:
    """视频处理器"""

    def __init__(self, config: dict):
        self.upload_dir = Path(config["files"]["upload_dir"])
        self.scan_interval = config["processor"]["scan_interval"]
        self.running = False

    async def start(self):
        """启动处理器"""
        self.running = True
        while self.running:
            await self._scan_and_process()
            await asyncio.sleep(self.scan_interval)

    async def _scan_and_process(self):
        """扫描并处理视频"""
        # 扫描upload目录
        # 移动到processing目录
        # 提取音频
        # ASR识别
        # 保存结果
        # 删除原视频
        pass
```

### 6.3 processor/file_manager.py（新建）

```python
"""
文件管理器
管理视频文件的移动和清理
"""

from pathlib import Path
import shutil

class FileManager:
    """文件管理器"""

    def __init__(self, config: dict):
        self.upload_dir = Path(config["files"]["upload_dir"])
        self.processing_dir = Path(config["files"]["processing_dir"])

    def move_to_processing(self, video_path: Path) -> Path:
        """移动视频到处理目录"""
        pass

    def delete_video(self, video_path: Path):
        """删除视频文件"""
        pass
```

## 7. 复用现有代码

从现有项目 `douying-collect` 复用以下模块：

| 原文件 | 目标文件 | 修改说明 |
|--------|----------|----------|
| `src/audio_extractor.py` | `src/processor/audio_extractor.py` | 直接复用 |
| `src/asr_client.py` | `src/processor/asr_client.py` | 直接复用 |
| `src/models.py` | `src/models.py` | 保留完整的数据模型 |

## 8. 启动脚本（scripts/run.sh）

```bash
#!/bin/bash
cd "$(dirname "$0")/.."
source .venv/bin/activate
python main.py
```

## 9. 服务配置（systemd）

创建 `/etc/systemd/system/douyin-processor.service`：

```ini
[Unit]
Description=Douyin Video Processor
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/douyin-processor
ExecStart=/path/to/douyin-processor/.venv/bin/python main.py
Restart=always

[Install]
WantedBy=multi-user.target
```

## 10. 依赖项（pyproject.toml）

```toml
[project]
name = "douyin-processor"
version = "1.0.0"
requires-python = ">=3.12"
dependencies = [
    "fastapi",
    "uvicorn",
    "ffmpeg-python",
    "pyyaml",
    "loguru",
    "httpx",
]
```

## 11. 数据流

```
Windows端上传
    │
    v
接收文件到 data/upload/
    │
    v
定时扫描（每15分钟）
    │
    v
移动到 data/processing/
    │
    v
提取音频（FFmpeg）
    │
    v
ASR识别（阿里云）
    │
    v
保存结果到 data/output/
    │
    v
删除原视频
```

## 12. 文件命名规范

| 类型 | 命名格式 | 示例 |
|------|----------|------|
| 视频 | {aweme_id}.mp4 | 7123456789012345678.mp4 |
| 音频 | {aweme_id}.wav | 7123456789012345678.wav |
| 文字稿 | {aweme_id}.txt | 7123456789012345678.txt |
| JSON数据 | {aweme_id}.json | 7123456789012345678.json |

## 13. 实施步骤

1. 创建项目目录结构
2. 从现有项目复制音频处理和ASR代码
3. 新建API服务器和处理器
4. 创建配置文件
5. 部署到ECS
6. 端到端测试

## 14. 风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| 文件损坏 | 删除并记录错误 |
| ASR失败 | 重试3次，失败则标记为永久错误 |
| 磁盘空间不足 | 监控磁盘空间，处理完成后立即删除原视频 |
| 并发处理 | 使用文件锁机制 |
