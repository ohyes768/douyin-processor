# douyin-processor 数据字典

## 数据模型

### 1. VideoFile (视频文件信息)

**描述**：从 file-system-go 获取的音频文件信息

| 字段 | 类型 | 说明 |
|------|------|------|
| aweme_id | str | 视频/音频 ID |
| filename | str | 文件名（如：7609169800750206794.wav） |
| size | int | 文件大小（字节） |
| url | str | 文件访问 URL（完整公网地址） |

---

### 2. TranscriptResult (ASR 识别结果)

**描述**：阿里云 ASR 识别返回的转写结果

| 字段 | 类型 | 说明 |
|------|------|------|
| text | str | 完整识别文本 |
| segments | List[TranscriptSegment] | 分段识别结果 |
| confidence | float | 整体置信度（0-1） |
| audio_duration | float | 音频时长（秒） |

---

### 3. TranscriptSegment (识别分段)

**描述**：ASR 识别的时间分段结果

| 字段 | 类型 | 说明 |
|------|------|------|
| start_time | float | 分段开始时间（秒） |
| end_time | float | 分段结束时间（秒） |
| text | str | 该段识别文本 |
| confidence | float | 该段置信度（0-1） |

---

### 4. ProcessResult (处理结果)

**描述**：音频处理的结果状态

| 字段 | 类型 | 说明 |
|------|------|------|
| aweme_id | str | 视频/音频 ID |
| success | bool | 是否处理成功 |
| transcript | TranscriptResult | 识别结果（成功时） |
| error_message | str | 错误信息（失败时） |
| process_time | float | 处理耗时（秒） |

---

## 数据存储

### 本地文件存储

#### 识别结果文件

**路径**：`data/output/{aweme_id}.json`

**格式**：
```json
{
  "aweme_id": "7609169800750206794",
  "text": "完整的识别文本",
  "segments": [
    {
      "start_time": 0.0,
      "end_time": 2.5,
      "text": "第一段文本",
      "confidence": 0.95
    }
  ],
  "confidence": 0.92,
  "audio_duration": 60.5
}
```

#### 状态文件

**路径**：`data/status.json`

**格式**：
```json
{
  "7609169800750206794": {
    "status": "completed",
    "updated_at": "2026-02-28T13:30:00"
  },
  "7609169800750206795": {
    "status": "processing",
    "updated_at": "2026-02-28T13:31:00"
  },
  "7609169800750206796": {
    "status": "failed",
    "error": "FILE_DOWNLOAD_FAILED",
    "updated_at": "2026-02-28T13:32:00"
  }
}
```

**状态值**：
| 状态 | 说明 |
|------|------|
| pending | 等待处理 |
| processing | 处理中 |
| completed | 处理完成 |
| failed | 处理失败 |

---

## 外部服务交互

### file-system-go

**查询音频列表请求**：
```http
POST /api/videos/query
Content-Type: application/json

{
  "filters": {
    "suffix": ".wav"
  }
}
```

**响应**：
```json
{
  "success": true,
  "videos": [
    {
      "filename": "7609169800750206794.wav",
      "size": 5242880,
      "url": "/audio/7609169800750206794.wav"
    }
  ]
}
```

### 阿里云百炼平台 ASR

**提交识别任务**：
```http
POST https://dashscope.aliyuncs.com/api/v1/services/audio/asr/transcription
Authorization: Bearer {api_key}
X-DashScope-Async: enable
Content-Type: application/json

{
  "model": "fun-asr",
  "input": {
    "file_urls": ["http://ecs-ip:8000/audio/xxx.wav"]
  },
  "parameters": {
    "channel_id": [0]
  }
}
```

**响应**：
```json
{
  "output": {
    "task_id": "9611b951-bd8d-4384-b61e-f2ad6c4b5820"
  }
}
```

---

## 配置数据

### 环境变量

| 变量名 | 说明 | 示例 |
|--------|------|------|
| ALIYUN_ACCESS_KEY | 阿里云百炼平台 API Key | sk-xxxxxxxxxxxxx |

### 配置文件 (config/app.yaml)

```yaml
app:
  server:
    host: "0.0.0.0"
    port: 8093

  filesystem:
    base_url: "http://file-system-go:8000"
    query_endpoint: "/api/videos/query"
    timeout: 30

  files:
    output_dir: "data/output"
    status_file: "data/status.json"

  asr:
    provider: "aliyun"
    model: "fun-asr"
    access_key: "ALIYUN_ACCESS_KEY"

  logging:
    level: "INFO"
    console: true
    file: true
    dir: "logs"
```

---

## 数据流图

```
┌─────────────────────────────────────────────────────────────┐
│                    file-system-go                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ GET /api/videos/query → WAV 文件列表                │    │
│  │ filename, size, url (相对路径)                      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ↓ 拼接完整 URL
┌─────────────────────────────────────────────────────────────┐
│                   douyin-processor                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 处理音频 → 调用 ASR                                  │    │
│  │ file_url (完整公网 URL)                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                              │                              │
│                              ↓                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 保存结果 → data/output/{aweme_id}.json              │    │
│  │ text, segments, confidence, audio_duration          │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     前端 / n8n                              │
│  GET /api/videos/{aweme_id}/result → JSON 数据              │
└─────────────────────────────────────────────────────────────┘
```

---

## 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.1.0 | 2026-02-28 | 架构调整：移除音频下载，直接使用 URL |
| 1.0.0 | 2026-02-27 | 初始版本 |
