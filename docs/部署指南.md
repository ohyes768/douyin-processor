# douyin-processor ECS 部署指南

## 前置要求

- 阿里云 ECS（推荐 2 核 4G 及以上）
- 已安装 Docker 和 docker-compose
- 已部署 file-system-go 服务
- 已部署 api-gateway 服务

## 服务架构

```
                    ┌─────────────────────────────────────┐
                    │           api-gateway:8010          │
                    │   /api/douyin/process               │
                    │   /api/douyin/videos/{id}/result   │
                    └──────────────────┬──────────────────┘
                                       │ Docker Network
                    ┌──────────────────┴──────────────────┐
                    │      douyin-processor:8093          │
                    │   /api/process                      │
                    │   /api/videos/{id}/result           │
                    └──────────────────┬──────────────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │      file-system-go:8000            │
                    │   (WAV 音频文件)                     │
                    └─────────────────────────────────────┘
```

## 部署顺序

### 方式一：独立部署（推荐用于 ECS）

1. **先部署 api-gateway**（创建网络）
2. **再部署 douyin-processor**（加入现有网络）

### 方式二：统一部署

使用 `docker-compose-ecs.yml` 统一管理所有服务。

## 独立部署步骤

### 1. 部署 api-gateway

```bash
cd /path/to/api-gateway
docker-compose up -d
# 网络名称: api-gateway_api-network
```

### 2. 部署 douyin-processor

```bash
cd /path/to/douyin-processor

# 配置环境变量
cp .env.example .env
vim .env
# 填入: ALIYUN_ACCESS_KEY=sk-你的实际Key

# 修改 config/app.yaml 中的 file-system-go 地址
vim config/app.yaml
# base_url: "http://内网IP:8000"

# 启动服务（会自动加入 api-gateway 的网络）
docker-compose up -d
```

### 3. 验证服务连通性

```bash
# 检查容器是否在同一网络
docker network inspect api-gateway_api-network

# 测试直连
curl http://localhost:8093/health

# 测试网关代理
curl http://localhost:8010/api/douyin/health
```

## 统一部署（docker-compose-ecs.yml）

使用统一的编排文件部署所有服务：

```bash
# 进入项目根目录
cd /path/to/projects

# 启动所有服务
docker-compose -f docker-compose-ecs.yml up -d

# 查看状态
docker-compose -f docker-compose-ecs.yml ps

# 查看日志
docker-compose -f docker-compose-ecs.yml logs -f douyin-processor
```

## API 网关路由

通过 api-gateway 访问 douyin-processor：

| 功能 | 网关路由 | 后端路由 |
|------|----------|----------|
| 处理音频 | POST `/api/douyin/process` | `/api/process` |
| 查询结果 | GET `/api/douyin/videos/{id}/result` | `/api/videos/{id}/result` |
| 健康检查 | GET `/api/douyin/health` | `/health` |

## 直接访问（绕过网关）

也可以直接访问 douyin-processor：

```bash
# 健康检查
curl http://localhost:8093/health

# 处理音频
curl -X POST http://localhost:8093/api/process

# 查询结果
curl http://localhost:8093/api/videos/7609169800750206794/result

# API 文档
# 浏览器访问: http://localhost:8093/docs
```

## 防火墙配置

在阿里云 ECS 安全组中开放端口：

| 协议 | 端口 | 说明 | 内网访问 |
|------|------|------|----------|
| TCP | 8010 | api-gateway 入口 | ✅ 公网 |
| TCP | 8093 | douyin-processor | ❌ 仅内网 |
| TCP | 8000 | file-system-go | ❌ 仅内网 |

**推荐**：只开放 8010 到公网，其他服务通过内网通信。

## 常用命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f douyin-processor

# 重启服务
docker-compose restart douyin-processor

# 停止服务
docker-compose down

# 进入容器调试
docker-compose exec douyin-processor bash
```

## 故障排查

### 服务无法连接

```bash
# 检查网络
docker network ls
docker network inspect api-gateway_api-network

# 检查容器是否都在同一网络
docker ps --format "table {{.Names}}\t{{.Networks}}"
```

### 网关代理失败

```bash
# 检查 api-gateway 日志
cd /path/to/api-gateway
docker-compose logs -f

# 检查服务配置
cat config/services.yaml
```

### file-system-go 连接失败

检查 `config/app.yaml` 中的地址，使用内网 IP：

```yaml
app:
  filesystem:
    base_url: "http://172.17.0.x:8000"  # Docker 内网 IP
```

## Docker 镜像源

本项目的 Dockerfile 已配置国内镜像源：

- **APT 源**：阿里云镜像 `https://mirrors.aliyun.com`
- **PIP 源**：清华大学镜像 `https://pypi.tuna.tsinghua.edu.cn/simple`

构建速度已优化，适合国内环境。
